<!DOCTYPE html>
<html>

<head>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script>

    <!-- <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
        crossorigin="anonymous"></script> -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script> -->
    <script src="login-manager.js"></script>
    <script src="/static/test.js"></script>
    <link href="styles.css" rel="stylesheet">
</head>

<body>
    <div class="d-flex flex-row" style="height: 100vh;">
        <div class="bg-secondary-subtle d-none d-lg-block" style="width: 320px; min-width: 320px; max-width: 320px; overflow: auto;">
            <h1>Sidenav</h1>
            <div class="d-flex flex-column justify-content-center p-3" style="height: calc(100vh - 56px);">
                <!-- <div class="align-self-start">
                    <button type="button" class="btn btn-primary">Primary</button>
                </div> -->
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" type="button">Attività</button>
                    <button class="btn btn-outline-primary" type="button">Le mie prenotazioni</button>
                    <button class="btn btn-outline-primary" type="button">Storico prenotazioni</button>
                    <button class="btn btn-outline-primary" type="button">Premi</button>
                </div>
            </div>
        </div>
        <div class="container-fluid bg-warning-subtle" style="overflow: auto;">
            <!-- <h1 class="bg-warning-subtle" style="position: sticky; top: 0; z-index: 100;">Content</h1> -->
            <div class="navbar">
                <!-- <div style="display: flex; flex-direction: row; align-items: center;">
                    <div class="rounded-circle" style="height: 32px; width: 32px; background-color: orange; margin-right: 8px;"></div>
                    <span>Mario Rossi</span>
                </div> -->
                <div id="user-logged-in" class="dropdown d-none">
                    <button class="btn dropdown-toggle navbar-dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <div id="user-avatar" class="rounded-circle user-avatar"></div>
                        <span id="user-full-name">Nome utente</span>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item">Profilo</a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><button class="dropdown-item btn btn-danger" onclick="logout()">Logout</button></li>
                    </ul>
                </div>
                <div id="user-logged-out" class="dropdown d-none">
                    <button class="btn dropdown-toggle navbar-dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <span id="user-full-name">Anonimo</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><button class="dropdown-item" onclick="handleLogin()">Login</button></li>
                    </ul>
                </div>
            </div> 
            <div class="row p-3">
                <div class="column border rounded p-3" style="background-color: white;">
                    <h2 class="mb-3">Attività</h2>
                    <div class="input-group mb-3">
                        <input id="search-input" type="text" class="form-control" placeholder="Cerca..." aria-label="Cerca...">
                        <span class="input-group-text">@</span>
                    </div>
                    <div class="d-flex flex-row flex-wrap mb-3" style="row-gap: 1rem; column-gap: 1rem">
                        <div class="d-flex flex-row align-content-center">
                            <span>Sport:&nbsp;</span>
                            <select id="sport-select" class="form-select form-select-sm" aria-label="Default select example" style="width: unset;">
                                <option value="ALL" selected>Tutti</option>
                                <option value="RUNNING">Corsa/Jogging</option>
                                <option value="TENNIS">Tennis</option>
                                <option value="BODYBUILDING">Sollevamento pesi</option>
                                <option disabled value="FOOTBALL">Calcio</option>
                            </select>
                        </div>
                        <div class="d-flex flex-row align-content-center">
                            <span>Località:&nbsp;</span>
                            <select id="location-select" class="form-select form-select-sm" aria-label="Default select example" style="width: unset;">
                                <option value="ALL" selected>Tutte</option>
                                <option value="SABAUDIA">Sabaudia</option>
                                <option value="LATINA">Latina</option>
                                <option value="TERRACINA">Terracina</option>
                            </select>
                        </div>
                    </div>
                    <!-- <div class="activities-container">
                        <div class="p-3 border rounded activity-card">
                            <p class="activity-card_title">Corsa/Jogging - <a href="">Passione Corsa</a></p>
                            <p>Data: 11/11/2025</p>
                            <p>Orari disponibili: 10:00, 16:00, 18:00</p>
                            <p>Posti disponibili: 10</p>
                            <p>Località: Sabaudia</p>
                        </div>
                        <div class="p-3 border rounded" style="flex-grow: 1;">
                            <p style="font-size: 20px; font-weight: bold;">Corsa/Jogging - <a href="">Passione Corsa</a></p>
                            <p>Data: 11/11/2025</p>
                            <p>Orari disponibili: 10:00, 16:00, 18:00</p>
                            <p>Posti disponibili: 10</p>
                            <p>Località: Sabaudia</p>
                        </div>
                        <div class="p-3 border rounded" style="flex-grow: 1;">
                            <p style="font-size: 20px; font-weight: bold;">Corsa/Jogging - <a href="">Passione Corsa</a></p>
                            <p>Data: 11/11/2025</p>
                            <p>Orari disponibili: 10:00, 16:00, 18:00</p>
                            <p>Posti disponibili: 10</p>
                            <p>Località: Sabaudia</p>
                        </div>
                    </div> -->
                    <div class="column activities-container" id="activities"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const values = {
            search: null,
            sport: null,
            location: null,
        };
        const user = LoginManager.getUser();
        console.log(user);
        let timeoutRef = null;

        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('input', handleSearch);
        
        const sportSelect = document.getElementById('sport-select');
        sportSelect.addEventListener('input', handleChangeSport);
        
        const locationSelect = document.getElementById('location-select');
        locationSelect.addEventListener('input', handleChangeLocation);

        const activitiesContainer = document.getElementById('activities');
        const userProfileAvatar = document.getElementById('user-avatar');
        const userProfileDropdown = document.getElementById('user-full-name');
        const userProfileDropdownLoggedIn = document.getElementById('user-logged-in');
        const userProfileDropdownLoggedOut = document.getElementById('user-logged-out');

        initValues();
        loadActivities();
        // login();

        function getCookie(cookieName) {
            return document.cookie
                .split("; ")
                .find((cookie) => cookie.startsWith(cookieName + "="))
                ?.split("=")[1] || null;
        }

        function handleSearch(event) {
            values.search = searchInput.value || null;
            loadActivities();
        }

        function handleChangeSport(event) {
            if (!sportSelect.value || sportSelect.value === 'ALL') {
                values.sport = null;
            } else {
                values.sport = sportSelect.value;
            }
            loadActivities();
        }

        function handleChangeLocation(event) {
            if (!locationSelect.value || locationSelect.value === 'ALL') {
                values.location = null;
            } else {
                values.location = locationSelect.value;
            }
            loadActivities();
        }

        function initValues() {
            values.search = searchInput.value || null;
            if (!sportSelect.value || sportSelect.value === 'ALL') {
                values.sport = null;
            } else {
                values.sport = sportSelect.value;
            }
            if (!locationSelect.value || locationSelect.value === 'ALL') {
                values.location = null;
            } else {
                values.location = locationSelect.value;
            }
            console.log(values);
            updateUserDropdown();
        }

        function loadActivities() {
            if (timeoutRef !== null) {
                clearTimeout(timeoutRef);
                console.log('Cancelling timeout...');
            }
            timeoutRef = setTimeout(fetchActivities, 500);
        }

        async function fetchActivities() {
            timeoutRef = null;
            console.log('Fetching activities...');
            activitiesContainer.replaceChildren();
            const loadingElem = document.createElement('p');
            loadingElem.classList = 'query-message';
            loadingElem.innerText = 'Caricamento...';
            activitiesContainer.appendChild(loadingElem);
            await new Promise(r => setTimeout(r, 1000));
            var url = new URL('http://localhost:5000/activities');
            Object.keys(values)
                .forEach(key => {
                    if (!values[key]) return;
                    url.searchParams.append(key, values[key])
                });
            const activities = await fetch(url)
                .then(result => result.json())
                .catch(() => []);
            activitiesContainer.replaceChildren();
            if (!activities.length) {
                const noActivitiesElem = document.createElement('p');
                noActivitiesElem.className = 'query-message';
                noActivitiesElem.innerText = 'Nessuna attività trovata';
                activitiesContainer.appendChild(noActivitiesElem);
            } else {
                activities.forEach(activity => {
                    const card = document.createElement('div');
                    card.className = 'p-3 border rounded activity-card';
                    const title = document.createElement('p');
                    title.className = 'activity-card_title';
                    title.innerHTML = `${activity.sport} - <a href="company/company.html?companyId=${activity.company_id}&companyName=${activity.company_name}">${activity.company_name}</a>`;
                    card.appendChild(title);
                    card.appendChild(createParagraph(`Data: ${activity.date}`));
                    card.appendChild(createParagraph(`Orari disponibili: ${activity.times.split('; ').join(' - ')}`));
                    card.appendChild(createParagraph(`Posti disponibili: ${activity.max_partecipants}`));
                    card.appendChild(createParagraph(`Località: ${activity.location}`));
                    activitiesContainer.appendChild(card);
                });
            }
        }

        function createParagraph(textContent) {
            const paragraph = document.createElement('p');
            paragraph.innerText = textContent;
            return paragraph;
        }

        // async function login() {
        //     const response = await fetch('http://localhost:5000/login')
        //         .then(result => result.json());
        //     if (response.result === 'OK') {
        //         localStorage.setItem('userId', response.user.id);
        //         localStorage.setItem('userFullName', response.user.name + ' ' + response.user.surname);
        //         user.id = localStorage.getItem('userFullName');
        //         user.fullName = localStorage.getItem('userFullName');
        //         updateUserDropdown();
        //     } else {
        //         logout();
        //     }
        // }

        function handleLogin() {
            window.location.href = "login.html";
        }

        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('userFullName');
            user.id = null;
            user.fullName = null;
            updateUserDropdown();
        }

        function updateUserDropdown() {
            if (user.id) {
                userProfileAvatar.classList.remove('d-none');
                userProfileDropdown.innerText = user.fullName;
                userProfileDropdownLoggedIn.classList.remove('d-none');
                userProfileDropdownLoggedOut.classList.add('d-none');
            } else {
                userProfileAvatar.classList.add('d-none');
                userProfileDropdown.innerText = 'Anonimo';
                userProfileDropdownLoggedIn.classList.add('d-none');
                userProfileDropdownLoggedOut.classList.remove('d-none');
            }
        }
    </script>
</body>

</html>